var karacos = require('karacos'),
	assert = require('assert'),
	Domain, logger,
	log4js = require('log4js')(),
	sys = require('sys');

logger = log4js.getLogger('karacos.model.Domain');

Domain = karacos.model.Parent.extend({
	logger: logger,
	init: function(values) {
		this._super(values);
		this.domain = this;
	},
	map: {
		name: "Domain:{id}:name",
		fqdn: "Domain:{id}:fqdn",
		theme: "Domain:{id}:theme"
	},
	get_theme: function() {
		if (!('theme' in this._data)|| this._data.theme === null  || this._data.theme === undefined || this._data.theme === "") {
			logger.debug('Setting theme to default');
			this.attr('theme','default');
		}
		return this.attr('theme');
	}
	
}, 'Domain');

//Domain.map = {
//	fqdn: "Domain:{id}:fqdn"
//};

/**
 * 
 */
function get_by_fqdn(fqdn, callback) {
	var client = karacos.wrapper.getClient();
	logger.debug("get_by_fqdn:Looking for domain " + fqdn);
	client.keys("Domain:*:fqdn*", function(err, domainkeys){
		var id;
		logger.debug("get_by_fqdn:replies Domain:*:fqdn : " + domainkeys.length + " found - " + domainkeys);
		if (domainkeys.length !== 0) {
			// at least one domain key in redis
			client.mget(domainkeys, function(err, domainfqdns){
				// f
				logger.debug("get_by_fqdn: domainfqdns : " + domainfqdns)
				if (domainfqdns.sort().indexOf(fqdn) === -1) {
					logger.info('get_by_fqdn: No domain found with that fqdn :' + fqdn);
					if (typeof callback !== "undefined")
						callback({message:"No domain found with that fqdn:"},undefined);
					return;
				}
				assert.ok(domainfqdns.indexOf(fqdn) === domainfqdns.lastIndexOf(fqdn), "More than one domain with same fqdn");
				id = domainfqdns[domainfqdns.indexOf(fqdn)].split(':')[1];
				logger.debug("get_by_fqdn:foundId:"+id);
				karacos.wrapper.get(id, function(err, domain){
					if (typeof callback !== "undefined")
						callback(err,domain);
				});
			});
		} else {
			if (typeof callback !== "undefined")
				callback({message:"No domains in system"},undefined);
			logger.info("get_by_fqdn: No domains in system");
		}
	});
} 
Domain.get_by_fqdn = get_by_fqdn;

/**
 * Static method, gets a domain by it's fqdn
 */
function get_by_name(name, callback) {
	var client = karacos.wrapper.getClient();
	logger.debug("get_by_name:Looking for domain " + name);
	client.keys("Domain:*:name", function(err, domainkeys){
		var id;
		logger.debug("get_by_name:replies Domain:*:name : " + domainkeys.length + " found - " + domainkeys);
		if (domainkeys.length !== 0) {
			// at least one domain key in redis
			client.mget(domainkeys, function(err, domainnames){
				// f
				logger.debug("get_by_name: domainnames : " + domainnames)
				if (domainnames.sort().indexOf(name) === -1) {
					logger.info('get_by_name: No domain found with that name');
					if (typeof callback !== "undefined")
						callback({message:"No domain found with that name " + name},undefined);
					return;
				}
				assert.ok(domainnames.indexOf(name) === domainnames.lastIndexOf(name), "More than one domain with the same name");
				id = domainkeys[domainnames.indexOf(name)].split(':')[1];
				logger.debug("get_by_name:foundId:"+id);
				karacos.wrapper.get(id, function(err, domain){
					if (typeof callback !== "undefined")
						callback(err,domain);
				});
			});
		} else {
			if (typeof callback !== "undefined")
				callback({message:"No domains in system"},undefined);
			logger.info("get_by_name: No domains in system");
		}
	});
}
Domain.get_by_name = get_by_name;

/**
 * Static method for creating a domain
 * @param data
 * @param callback
 */
function create(data, callback) {
	var client = karacos.wrapper.getClient(),
		id,
		key;
	if (typeof data.type === "undefined") {
		data.type = 'Domain';
	}
	if (typeof data.theme === "undefined") {
		data.theme = 'default';
	}
	logger.debug("attemp to create domain with data: " + sys.inspect(data));
	this.get_by_name(data.name, function(error, domain) {
		var keyname;
		logger.debug("create: Expecting empty result: " + domain);
		if (typeof domain !== "undefined") {
			if (typeof callback !== "undefined")
				callback({message:"Domain already exist with that name"},domain);
		} else {
			// Creates the domain, generates object id
			karacos.model.Parent.create(data, function(error, domain) {
				if (typeof callback !== "undefined")
					callback(error,domain);
			});
		} 
	});
}
Domain.create = create;