var redis = require("redis"),
	redis2json = require("../../deps/redis2json"),
	karacos = require('karacos'),
	log4js = require('log4js')(), logger;
logger = log4js.getLogger('karacos:wrapper');
redis2json.redis = redis;

function getClient() {
	var client;
	if (typeof client === "undefined") {
		logger.debug('getClient: Creating client connexion');
		var client = redis.createClient(6379, "127.0.0.1");
	}
	return client;
};

function endClient(){
	if (typeof client !== "undefined") {
		logger.debug('endClient: Terminating client connexion');
		client.end();
		client = "undefined";
	}
}

redis2json.client = getClient();

exports.get = function(id, callback) {
	var type,
		doc, map, variable, model;
	logger.debug("get:get id:" + id);	
	getClient().get(id, function(err, res) {
		var variable;
		if (typeof res !== "null") {
			type = res;
			if (type in karacos.model) {
				model = karacos.model[type];
				map = model.prototype.map;
				variable = {id: id};
				//logger.debug("get: model:");
				//console.log(model);
				//logger.debug("get: map:");
				//console.log(map);
				//logger.debug("get: variable:");
				//console.log(variable);
				// hangs occurs ..... when using nedis
				redis2json.load(map, variable, function (error, result) {
					logger.debug("get:Redis2json load, result:" + result);
					//console.log(result);
					if (typeof callback !== "undefined")
						callback(undefined, new model(result));
				});
			} else {
				if (typeof callback !== "undefined")
					callback(undefined, res);
			}
		} else {
			if (typeof callback !== "undefined")
				callback(err);
		}
	});
};

exports.getClient = getClient;
exports.endClient = endClient;